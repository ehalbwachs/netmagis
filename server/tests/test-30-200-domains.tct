set uri /netmagis/domains

test-reset-cookie

#########################################################################
lassign [test-call GET $uri {}] stcode stmsg ct body
test-assert 10 "Get domain without auth -> error" \
	{$stcode == 401}

#########################################################################
lassign [test-call GET $uri/1 {}] stcode stmsg ct body
test-assert 20 "Get a single domain, without auth -> error" \
	{$stcode == 401}

#########################################################################
test-set-cookie session t6-smtp

set expectedjson {
    [
	{
	    "iddom": 1,
	    "mailrole": 1,
	    "name": "example.com"
	},
	{
	    "iddom": 2,
	    "mailrole": 1,
	    "name": "example.org"
	}
    ]
}
lassign [test-call GET $uri {}] stcode stmsg ct body
test-assert 100 "Get all domains -> 2 domains" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
test-set-cookie session t2-simple

set expectedjson {
    [
	{
	    "iddom": 1,
	    "mailrole": 1,
	    "name": "example.com"
	}
    ]
}
lassign [test-call GET $uri {}] stcode stmsg ct body
test-assert 110 "Get all domains -> only one" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
test-set-cookie session t6-smtp

set expectedjson {
    [
	{
	    "iddom": 1,
	    "mailrole": 1,
	    "name": "example.com"
	},
	{
	    "iddom": 2,
	    "mailrole": 1,
	    "name": "example.org"
	}
    ]
}
lassign [test-call GET $uri?mailrole=1 {}] stcode stmsg ct body
test-assert 120 "Get all domains with mailroles -> all domains" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
set expectedjson {
    [
    ]
}
lassign [test-call GET $uri?mailrole=0 {}] stcode stmsg ct body

test-assert 130 "Get all domains without mailroles -> none" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
set expectedjson {
    {
	"iddom": 1,
	"mailrole": 1,
	"name": "example.com"
    }
}
lassign [test-call GET $uri/1 {}] stcode stmsg ct body
test-assert 140 "Get a single domain" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
set expectedjson {
    {
	"iddom": 1,
	"mailrole": 1,
	"name": "example.com"
    }
}
lassign [test-call GET $uri/1?mailrole=1 {}] stcode stmsg ct body
test-assert 150 "Get a single domain, with mailrole" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
lassign [test-call GET $uri/1?mailrole=0 {}] stcode stmsg ct body
test-assert 160 "Get a single domain, without mail role -> error" \
	{$stcode == 404}
