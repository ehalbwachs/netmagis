set uri /netmagis/aliases

test-reset-cookie

#########################################################################
lassign [test-call GET $uri {}] stcode stmsg ct body
test-assert 10 "Get aliases without auth -> error" \
	{$stcode == 401}


test-set-cookie session t1-wheel

#########################################################################
set expectedjson {
    [
	{
	    "idalias": 223,
	    "iddom": 1,
	    "idhost": 5,
	    "idview": 2,
	    "name": "intranet",
	    "ttl": -1
	},
	{
	    "idalias": 232,
	    "iddom": 1,
	    "idhost": 230,
	    "idview": 3,
	    "name": "a-marvelous-product",
	    "ttl": -1
	},
	{
	    "idalias": 233,
	    "iddom": 2,
	    "idhost": 230,
	    "idview": 3,
	    "name": "www",
	    "ttl": -1
	}
    ]
}
lassign [test-call GET $uri {}] stcode stmsg ct body
test-assert 100 "Get all aliases" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}

#########################################################################
set expectedjson {
    [
	{
	    "idalias": 223,
	    "iddom": 1,
	    "idhost": 5,
	    "idview": 2,
	    "name": "intranet",
	    "ttl": -1
	}
    ]
}
lassign [test-call GET $uri?view=internal {}] stcode stmsg ct body
test-assert 110 "Get all aliases in view internal" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}


#########################################################################
set expectedjson {
    [
	{
	    "idalias": 223,
	    "iddom": 1,
	    "idhost": 5,
	    "idview": 2,
	    "name": "intranet",
	    "ttl": -1
	}
    ]
}
lassign [test-call GET $uri?name=intranet {}] stcode stmsg ct body
test-assert 120 "Get all aliases with name intranet" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}



#########################################################################
set expectedjson {
    [
	{
	    "idalias": 233,
	    "iddom": 2,
	    "idhost": 230,
	    "idview": 3,
	    "name": "www",
	    "ttl": -1
	}
    ]
}
lassign [test-call GET $uri?domain=example.org {}] stcode stmsg ct body
test-assert 130 "Get aliases with domain=example.org" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}



#########################################################################
set expectedjson {
    [
	{
	    "idalias": 223,
	    "iddom": 1,
	    "idhost": 5,
	    "idview": 2,
	    "name": "intranet",
	    "ttl": -1
	}
    ]
}
lassign [test-call GET $uri?idhost=5 {}] stcode stmsg ct body
test-assert 140 "Get aliases pointing to idhost 5" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}


#########################################################################
set expectedjson {
    [
	{
	    "idalias": 223,
	    "iddom": 1,
	    "idhost": 5,
	    "idview": 2,
	    "name": "intranet",
	    "ttl": -1
	}
    ]
}
lassign [test-call GET $uri?idhost=5&domain=example.com {}] stcode stmsg ct body
test-assert 150 "Get aliases with multiple criteria" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}


#########################################################################
set expectedjson {
    [
    ]
}
lassign [test-call GET $uri?idhost=5&domain=example.org {}] stcode stmsg ct body
test-assert 160 "Get aliases with multiple incompatible criteria" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}



#########################################################################
set inputjson {
    {
	"name": "alias1",
	"iddom": 1,
	"idview": 3,
	"idhost": 230,
	"ttl": null
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 170 "Add alias" \
	{$stcode == 200}
set alias1 $body

set expectedjson {
    [
	{
	    "idalias": %ID%,
	    "iddom": 1,
	    "idhost": 230,
	    "idview": 3,
	    "name": "alias1",
	    "ttl": -1
	}
    ]
}
regsub "%ID%" $expectedjson $alias1 expectedjson
lassign [test-call GET $uri?name=alias1 {}] stcode stmsg ct body
test-assert 201 "Fetch newly added alias" \
	{$stcode == 200 && [test-json $ct $body $expectedjson]}



#########################################################################
test-set-cookie session t2-simple
set inputjson {
    {
	"name": "inv-alias",
	"iddom": 1,
	"idview": 3,
	"idhost": 230,
	"ttl": null
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 180 "Attempt to add alias in invalid view" \
	{$stcode == 400}

#########################################################################
test-set-cookie session t2-simple
set inputjson {
    {
	"name": "inv-alias",
	"iddom": 2,
	"idview": 2,
	"idhost": 230,
	"ttl": null
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 190 "Attempt to add alias in invalid domain" \
	{$stcode == 400}

#########################################################################
test-set-cookie session t2-simple
set inputjson {
    {
	"name": "inv-alias",
	"iddom": 1,
	"idview": 2,
	"idhost": 230,
	"ttl": 123
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 200 "Attempt to add alias with a TTL without TTL right" \
	{$stcode == 400}


#########################################################################
test-set-cookie session t5-ttl
set inputjson {
    {
	"name": "alias2",
	"iddom": 1,
	"idview": 2,
	"idhost": 5,
	"ttl": 123
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 210 "Add alias with a TTL" \
	{$stcode == 200}


#########################################################################
test-set-cookie session t5-ttl
set inputjson {
    {
	"name": "alias2",
	"iddom": 1,
	"idview": 2,
	"idhost": 230,
	"ttl": 123
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 220 "Attempt to add an alias with an existing name" \
	{$stcode == 400}


#########################################################################
test-set-cookie session t2-simple
set inputjson {
    {
	"name": "invalid-alias",
	"iddom": 1,
	"idview": 2,
	"idhost": 230,
	"ttl": null
    }
}
lassign [test-call POST $uri $inputjson] stcode stmsg ct body
test-assert 230 "Attempt to add an alias in a different view than host" \
	{$stcode == 400}


#########################################################################
test-set-cookie session t2-simple
set inputjson {
    {
	"idhost": 230,
    }
}
lassign [test-call PUT $uri/230 $inputjson] stcode stmsg ct body
test-assert 240 "Attempt to modify an alias in a non-allowed view" \
	{$stcode == 404}


#########################################################################
test-set-cookie session t6-smtp
set inputjson {
    {
	"idhost": 230,
	"ttl": 123
    }
}
lassign [test-call PUT $uri/230 $inputjson] stcode stmsg ct body
test-assert 250 "Attempt to modify TTL of an alias without TTL right" \
	{$stcode == 404}


#########################################################################

lassign [test-call DELETE $uri/$alias1 {}] stcode stmsg ct body
test-assert 400 "Remove the added alias" \
	{$stcode == 200}

